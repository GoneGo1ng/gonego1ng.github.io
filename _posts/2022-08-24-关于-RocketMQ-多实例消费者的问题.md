---
title: å…³äº RocketMQ å¤šå®ä¾‹æ¶ˆè´¹è€…çš„ä¸€ä¸ªé—®é¢˜
date: 2022-08-24
description: çœæµï¼šè¿™ä¸ªé—®é¢˜ RocketMQ å·²ç»åœ¨ 4.9.4 ç‰ˆæœ¬ä¿®å¤äº†
categories:
- RocketMQ
tags:
- RocketMQ
---

# å‰è¨€

ä»Šå¤©åœ¨å’Œé¢†å¯¼è®¨è®ºå…³äº RocketMQ çš„ä½¿ç”¨è§„èŒƒæ—¶ï¼Œæˆ‘æå‡ºæˆ‘ä»¬å›¢é˜Ÿåœ¨å¼€å‘è¿‡ç¨‹ä¸­ä½¿ç”¨åˆ°äº†å¤šä¸ªå®ä¾‹çš„æ¶ˆè´¹è€…åˆ† tags æ¶ˆè´¹åŒä¸€ä¸ª topicã€‚
é¢†å¯¼æ•é”åœ°å¯Ÿè§‰åˆ°è¿™ç§ç”¨æ³•åœ¨é›†ç¾¤ç¯å¢ƒä¸‹ä½¿ç”¨å¾ˆå¯èƒ½æœ‰é—®é¢˜ï¼Œè®©æˆ‘éªŒè¯ä¸€ä¸‹ã€‚

# éªŒè¯

Consumer çš„ä»£ç å¦‚ä¸‹ï¼Œåœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Šèµ·äº†ä¸¤ä¸ªè¿›ç¨‹ï¼ˆä¹Ÿå°±æ˜¯ä¸¤ä¸ªæ¶ˆè´¹è€…ï¼‰ï¼ŒåŸæœ¬ä»¥ä¸ºä¼šå‡è¡¡çš„è´Ÿè½½åˆ°è¿™ä¸¤ä¸ªæ¶ˆè´¹è€…ä¸Šé¢ã€‚
ä½†æ˜¯ç»“æœå¹¶ä¸æ˜¯è¿™æ ·ï¼Œæˆ‘ä¸€å…±å‘é€äº†åæ¡æ¶ˆæ¯ï¼Œè¿™ä¸¤ä¸ªå¹¶æ²¡æœ‰æ”¶åˆ°å…¨éƒ¨åæ¡æ¶ˆæ¯ï¼Œå¹¶ä¸”æ”¶åˆ°çš„æ¶ˆæ¯å…¨éƒ½ç›¸åŒã€‚
è¿™ä¸ªç»“æœä¹Ÿè¯å®äº†é¢†å¯¼æå‡ºçš„ç–‘é—®ã€‚

```java
@RocketMQMessageListener(
        topic = "${demo.rocketmq.topic}",
        consumerGroup = "taga-consumer-group",
        selectorExpression = "${demo.rocketmq.tagA}"
)
public class TagAConsumer implements RocketMQListener<String>, RocketMQPushConsumerLifecycleListener {

    @Override
    public void onMessage(String message) {
        System.out.printf("------- TagAConsumer received: %s \n", message);
    }

    @Override
    public void prepareStart(DefaultMQPushConsumer consumer) {
        // è®¾ç½®å½“å‰å®ä¾‹çš„åç§°
        // consumer.setInstanceName("tag-a-consumer-instance@" + UtilAll.getPid());
        consumer.setInstanceName("tag-a-consumer-instance");
    }

}
```

# åˆ†æ

å¸¦ç€ä¸Šé¢è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘å¯¹ RocketMQ æºç è¿›è¡Œäº†ç®€å•åˆ†æã€‚
æŸ¥çœ‹ä¸‹é¢ä¸¤æ®µæºç ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç° RocketMQ é»˜è®¤çš„å¹³å‡è´Ÿè½½ç­–ç•¥æ˜¯æ ¹æ® clientId å»åˆ†é…çš„ï¼Œ
é‚£ä¹ˆï¼Œè¿™ä¸ª clientId åˆæ˜¯å“ªé‡Œæ¥çš„å‘¢ï¼Œæˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹ã€‚

[RebalanceImpl.java](https://github.com/apache/rocketmq/blob/develop/client/src/main/java/org/apache/rocketmq/client/impl/consumer/RebalanceImpl.java)

```java
...
        
AllocateMessageQueueStrategy strategy = this.allocateMessageQueueStrategy;

List<MessageQueue> allocateResult = null;
try {
    allocateResult = strategy.allocate(
        this.consumerGroup,
        this.mQClientFactory.getClientId(), // å…ˆçœ‹è¿™é‡Œ
        mqAll,
        cidAll);
} catch (Throwable e) {
    log.error("allocate message queue exception. strategy name: {}, ex: {}", strategy.getName(), e);
    return false;
}

...
```

AllocateMessageQueueAveragelyï¼šå¹³å‡è´Ÿè½½ç­–ç•¥ï¼ŒRocketMQ é»˜è®¤ä½¿ç”¨çš„ç­–ç•¥ã€‚
[AllocateMessageQueueAveragely.java](https://github.com/apache/rocketmq/blob/develop/client/src/main/java/org/apache/rocketmq/client/consumer/rebalance/AllocateMessageQueueAveragely.java)

```java
package org.apache.rocketmq.client.consumer.rebalance;

import java.util.ArrayList;
import java.util.List;
import org.apache.rocketmq.client.log.ClientLogger;
import org.apache.rocketmq.logging.InternalLogger;
import org.apache.rocketmq.common.message.MessageQueue;

/**
 * Average Hashing queue algorithm
 */
public class AllocateMessageQueueAveragely extends AbstractAllocateMessageQueueStrategy {

    public AllocateMessageQueueAveragely() {
        log = ClientLogger.getLog();
    }

    public AllocateMessageQueueAveragely(InternalLogger log) {
        this.log = log;
    }

    @Override
    public List<MessageQueue> allocate(String consumerGroup, String currentCID, List<MessageQueue> mqAll,
        List<String> cidAll) {

        List<MessageQueue> result = new ArrayList<MessageQueue>();
        if (!check(consumerGroup, currentCID, mqAll, cidAll)) {
            return result;
        }

        // å†çœ‹è¿™é‡Œ
        int index = cidAll.indexOf(currentCID);
        int mod = mqAll.size() % cidAll.size();
        int averageSize =
            mqAll.size() <= cidAll.size() ? 1 : (mod > 0 && index < mod ? mqAll.size() / cidAll.size()
                + 1 : mqAll.size() / cidAll.size());
        int startIndex = (mod > 0 && index < mod) ? index * averageSize : index * averageSize + mod;
        int range = Math.min(averageSize, mqAll.size() - startIndex);
        for (int i = 0; i < range; i++) {
            result.add(mqAll.get((startIndex + i) % mqAll.size()));
        }
        return result;
    }

    @Override
    public String getName() {
        return "AVG";
    }
}
```

ä»ä¸‹é¢è¿™æ®µæºç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå¦‚æœæˆ‘ä»¬è®¾ç½®äº†ä¸€ä¸ªå›ºå®šå€¼çš„ instanceNameï¼Œé‚£ä¹ˆç”Ÿæˆçš„ clientId çš„æ ¼å¼æ˜¯è¿™æ ·çš„ IP@instanceNameï¼Œ
å½“åŒä¸€ä¸ªæœåŠ¡å™¨ä¸ŠåŒæ—¶èµ·äº†ä¸¤ä¸ªæœåŠ¡ï¼ˆéå®¹å™¨ï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæœåŠ¡çš„ IP æ˜¯ç›¸åŒçš„ï¼ŒinstanceName ä¹Ÿæ˜¯ç›¸åŒçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ clientId ä¹Ÿæ˜¯ç›¸åŒçš„ã€‚
å†æ ¹æ®ä¸Šé¢çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ä»£ç ï¼Œæˆ‘ä»¬å°±ä¸éš¾çœ‹å‡ºä¸ºä»€ä¹ˆä¼šå‡ºç°æˆ‘å‰é¢éªŒè¯çš„é‚£ä¸ªé—®é¢˜äº†ã€‚

ClientConfig.java

```java
...

public String buildMQClientId() {
    StringBuilder sb = new StringBuilder();
    sb.append(this.getClientIP());

    sb.append("@");
    sb.append(this.getInstanceName());
    if (!UtilAll.isBlank(this.unitName)) {
    sb.append("@");
    sb.append(this.unitName);
    }

    return sb.toString();
}

...

public void changeInstanceNameToPID() {
    if (this.instanceName.equals("DEFAULT")) {
    this.instanceName = String.valueOf(UtilAll.getPid());
    }
}

...
```

> å¦‚æœæƒ³è¦è¿›ä¸€æ­¥åˆ†æ RocketMQ çš„æºç ï¼Œå¯ä»¥å‚è€ƒè¿™ä½å¤§ä½¬å†™çš„è¿™ç¯‡æ–‡ç« ï¼š
> [Rocketmqæºç åˆ†æ12ï¼šconsumer è´Ÿè½½å‡è¡¡](https://juejin.cn/post/6956391196981723167)

# ç»“è®º

ä¸Šé¢çš„é—®é¢˜ä¸€èˆ¬åªä¼šå‡ºç°åœ¨ä¸ä½¿ç”¨å®¹å™¨éƒ¨ç½²çš„é›†ç¾¤ç¯å¢ƒä¸‹ï¼ˆè€Œä¸”æ˜¯åŒä¸€å°æœåŠ¡å™¨ï¼‰ï¼Œ
æˆ‘ä»¬ç”Ÿäº§ç¯å¢ƒä¸€èˆ¬éƒ½æ˜¯ k8sï¼ˆcluster ipï¼‰ ä¹Ÿå°±æ˜¯è¯´ Consumer èµ·æ¥çš„æ—¶å€™æ‹¿åˆ°çš„ IP æ˜¯å®¹å™¨çš„ IPï¼Œ
ä¸å¤ªä¼šå‡ºç°ä¸Šé¢çš„é—®é¢˜ã€‚
ä½†å¼€å‘è¿‡ç¨‹ä¸­è¿˜æ˜¯è¦æ³¨æ„ï¼Œå»ºè®®åœ¨è®¾ç½® instanceName çš„æ—¶å€™åé¢åŠ ä¸€ä¸ªéšæœºæ•°ã€‚

# å†™åœ¨æœ€å

ğŸ˜ æ°”æ­»ï¼Œç¿»äº†ç¿» Git ä¸Š RocketMQ æœ€æ–°çš„æºç ï¼Œå‘ç°äººå®¶ RocketMQ æ—©å°±å·²ç»æŠŠè¿™ä¸ª BUG ä¿®å¤äº†ï¼Œ
æˆ‘è¿˜åœ¨è¿™é‡Œç”¨è€ç‰ˆæœ¬ï¼ˆrocketmq-client:4.8.0ï¼‰çš„ä»£ç åˆ†æäº†åŠå¤©ï¼Œæ°”æ­»äº†ï¼

[ClientConfig.java](https://github.com/apache/rocketmq/blob/develop/client/src/main/java/org/apache/rocketmq/client/ClientConfig.java)

```java
...

public String buildMQClientId() {
    StringBuilder sb = new StringBuilder();
    sb.append(this.getClientIP());

    sb.append("@");
    sb.append(this.getInstanceName());
    if (!UtilAll.isBlank(this.unitName)) {
        sb.append("@");
        sb.append(this.unitName);
    }

    if (enableStreamRequestType) {
        sb.append("@");
        sb.append(RequestType.STREAM);
    }

    return sb.toString();
}

...

public void changeInstanceNameToPID() {
    if (this.instanceName.equals("DEFAULT")) {
    this.instanceName = UtilAll.getPid() + "#" + System.nanoTime();
    }
}

...
```




